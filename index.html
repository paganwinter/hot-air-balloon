<html>
<head>
<title>Earth</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
}
.column {
  display: inline-block;
  position: absolute;
  /* width: 512px; */
  /* border-left: 1px solid #000; */
}
.tile {
  width: 256px;
  height: 256px;
  padding: 0;
  margin: 0;
  display: inline-block;
  font-size: 32px;
  color: white;
}
</style>
</style>
</head>
<body>

<div>
  <canvas id="canvas1" style="border: 1px solid black; margin: 20px;"></canvas>
</div>
<span id="coord-x"></span>
<span id="coord-y"></span>

<!-- <input type="range" min="1" max="100" list="tickmarks" onchange="changeSpeed(this.value)" /> -->
<!-- <img src="https://tile.openstreetmap.org/7/63/42.png" /> -->

<script>
// https://tile.openstreetmap.org/7/63/42.png

// const FPS = 60
// let frameWidth = 0
// const screenWidth = document.body.clientWidth

const speedMPS = 40075016.686 / (24 * 60 * 60)
const speedPPS = 0

const metersPerPixel = {
  0: 156543.03,
  1: 78271.52	,
  2: 39135.76,
  3: 19567.88,
  4: 9783.94,
  5: 4891.97,
  6: 2445.98,
  7: 1222.99,
  8: 611.50,
  9: 305.75,
  10: 152.87,
  11: 76.437,
  12: 38.219,
  13: 19.109,
  14: 9.5546,
  15: 4.7773,
  16: 2.3887,
  17: 1.1943,
  18: 0.5972,
}

let can = document.getElementById('canvas1')
let ctx = can.getContext('2d')
can.width = 256
can.height = 256

let img1 = new Image()
let img2 = new Image()

window.onload = function() {
  $coordX = document.getElementById('coord-x')

  let imgWidth = 0

  const urlParams = new URLSearchParams(window.location.search)
  let zoom = urlParams.get('zoom') || 0
  let scrollSpeed = urlParams.get('speed') || 8 // Math.pow(2, zoom)
  let yVal = parseInt(urlParams.get('y'))
  zoom = parseInt(zoom)
  scrollSpeed = parseInt(scrollSpeed)

  let tileCount = Math.pow(2, zoom)
  let x2Start = tileCount - 1

  let x2 = x2Start
  let x1 = x2 - 1
  let y

  if (yVal) {
    y = yVal
  } else {
    y = (tileCount === 1) ? 0 : (tileCount / 2) - 1
  }
  let z = zoom

  console.log({ x1, x2, y, z, zoom, scrollSpeed, tileCount })

  function loop(hrTime) {
    ctx.drawImage(img2, imgWidth, 0)
    ctx.drawImage(img1, imgWidth - can.width, 0)
    imgWidth += scrollSpeed

    if (imgWidth === can.width) {
      x2 = x2 - 1
      if (x2 < 0) {
        x2 = x2Start
      }
      x1 = x2 - 1
      if (x1 < 0) {
        x1 = x2Start
      }
      if (x1 > 0) {
        let imgPreload = new Image()
        imgPreload.src = `https://tile.openstreetmap.org/${z}/${x1 - 1}/${y}.png`
      }

      let img1Url = `https://tile.openstreetmap.org/${z}/${x1}/${y}.png`
      let img2Url = `https://tile.openstreetmap.org/${z}/${x2}/${y}.png`
      img1.src = img1Url
      img2.src = img2Url

      // $coordX.innerHTML = x2
      // console.log(img1Url, img2Url, imgWidth)

      imgWidth = 0
    }

    window.requestAnimationFrame(loop)
  }
  loop()
}
</script>

</body>
</html>
